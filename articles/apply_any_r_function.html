<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apply any R function on rolling windows • runner</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Apply any R function on rolling windows">
<meta property="og:description" content="runner">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-156194578-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-156194578-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">runner</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.4.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/apply_any_r_function.html">Apply any R function on rolling windows</a>
    </li>
    <li>
      <a href="../articles/built-in_functions.html">Built-in functions</a>
    </li>
    <li>
      <a href="../articles/runner_examples.html">Runner examples</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/gogonzo/runner/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Apply any R function on rolling windows</h1>
                        <h4 data-toc-skip class="author">Dawid
Kałędkowski</h4>
            
            <h4 data-toc-skip class="date">2024-03-04</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/gogonzo/runner/blob/HEAD/vignettes/apply_any_r_function.Rmd" class="external-link"><code>vignettes/apply_any_r_function.Rmd</code></a></small>
      <div class="hidden name"><code>apply_any_r_function.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="using-runner">Using runner<a class="anchor" aria-label="anchor" href="#using-runner"></a>
</h2>
<p><code>runner</code> package provides functions applied on running
windows. The most universal function is <code><a href="../reference/runner.html">runner::runner</a></code>
which gives user possibility to apply any R function <code>f</code> on
running windows. Running windows are defined for each data window size
<code>k</code>, <code>lag</code> with respect to their indexes. Unlike
other available R packages, <code>runner</code> supports any input and
output type and also gives full control to manipulate window size and
lag/lead.</p>
<p>There are different kinds of running windows and all of them are
implemented in <code>runner</code>.</p>
<div class="section level3">
<h3 id="cumulative-windows">Cumulative windows<a class="anchor" aria-label="anchor" href="#cumulative-windows"></a>
</h3>
<p>The simplest window type which is similar to
<code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">base::cumsum</a></code>. At each element window is defined by all
elements appearing before current.</p>
<p><img src="images/cumulative_windows.png"></p>
<p>In <code>runner</code> this can be achieved as simple by:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">runner</span><span class="op">)</span></span>
<span><span class="co"># full windows</span></span>
<span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarizing - sum</span></span>
<span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fl">15</span>,</span>
<span>  f <span class="op">=</span> <span class="va">sum</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarizing - concatenating</span></span>
<span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">15</span><span class="op">]</span>,</span>
<span>  f <span class="op">=</span> <span class="va">paste</span>,</span>
<span>  collapse <span class="op">=</span> <span class="st">" &gt; "</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="constant-sliding-windows">Constant sliding windows<a class="anchor" aria-label="anchor" href="#constant-sliding-windows"></a>
</h3>
<p>Second type of windows are these commonly known as
running/rolling/moving/sliding windows. This types of windows moves
along the index instead of cumulating like a previous one.<br>
Following diagram illustrates running windows of length
<code>k = 4</code>. Each of 15 windows contains 4 elements (except first
three).</p>
<p><img src="images/running_windows_explain.png"></p>
<p>To obtain constant sliding windows one just needs to specify
<code>k</code> argument</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># summarizing - sum of 4-elements</span></span>
<span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fl">15</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  f <span class="op">=</span> <span class="va">sum</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarizing - slope from lm</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span>,</span>
<span>  b <span class="op">=</span> <span class="fl">3</span> <span class="op">*</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">df</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">b</span> <span class="op">~</span> <span class="va">a</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coefficients</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span><span class="op">[</span><span class="st">"a"</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="windows-depending-on-date">Windows depending on date<a class="anchor" aria-label="anchor" href="#windows-depending-on-date"></a>
</h3>
<p>By default <code>runner</code> calculates on assumption that index
increments by one, but sometimes data points in dataset are not equally
spaced (missing weekends, holidays, other missings) and thus window size
should vary to keep expected time frame. If one specifies
<code>idx</code> argument, than running functions are applied on windows
depending on date rather on a sequence 1-n.  <code>idx</code> should be
the same length as <code>x</code> and should be of type
<code>Date</code>, <code>POSIXt</code> or <code>integer</code>. Example
below illustrates window of size <code>k = 5</code> lagged by
<code>lag = 1</code>. Note that one can specify also
<code>k = "5 days"</code> and <code>lag = "day"</code> as in
<code>seq.POSIXt</code>.<br>
In the example below in square brackets ranges for each window.</p>
<p><img src="images/running_date_windows.png"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">13</span>, <span class="fl">17</span>, <span class="fl">18</span>, <span class="fl">18</span>, <span class="fl">21</span>, <span class="fl">27</span>, <span class="fl">31</span>, <span class="fl">37</span>, <span class="fl">42</span>, <span class="fl">44</span>, <span class="fl">47</span>, <span class="fl">48</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summarize - mean</span></span>
<span><span class="fu">runner</span><span class="fu">::</span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">idx</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">5</span>, <span class="co"># 5-days window</span></span>
<span>  lag <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  idx <span class="op">=</span> <span class="va">idx</span>,</span>
<span>  f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># use Date or datetime sequences</span></span>
<span><span class="fu">runner</span><span class="fu">::</span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">idx</span>,</span>
<span>  k <span class="op">=</span> <span class="st">"5 days"</span>, <span class="co"># 5-days window</span></span>
<span>  lag <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">idx</span>,</span>
<span>  f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># obtain window from above illustration</span></span>
<span><span class="fu">runner</span><span class="fu">::</span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">idx</span>,</span>
<span>  k <span class="op">=</span> <span class="st">"5 days"</span>,</span>
<span>  lag <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">idx</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="running-at">running at<a class="anchor" aria-label="anchor" href="#running-at"></a>
</h3>
<p>Runner by default returns vector of the same size as <code>x</code>
unless one puts any-size vector to <code>at</code> argument. Each
element of <code>at</code> is an index on which runner calculates
function. Example below illustrates output of runner for
<code>at = c(13, 27, 45, 31)</code> which gives windows in ranges
enclosed in square brackets. Range for <code>at = 27</code> is
<code>[22, 26]</code> which is not available in current indices.</p>
<p><img src="images/runner_at_date.png"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">13</span>, <span class="fl">17</span>, <span class="fl">18</span>, <span class="fl">18</span>, <span class="fl">21</span>, <span class="fl">27</span>, <span class="fl">31</span>, <span class="fl">37</span>, <span class="fl">42</span>, <span class="fl">44</span>, <span class="fl">47</span>, <span class="fl">48</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># summary</span></span>
<span><span class="fu">runner</span><span class="fu">::</span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  lag <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  idx <span class="op">=</span> <span class="va">idx</span>,</span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">27</span>, <span class="fl">48</span>, <span class="fl">31</span><span class="op">)</span>,</span>
<span>  f <span class="op">=</span> <span class="va">mean</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># full window</span></span>
<span><span class="fu">runner</span><span class="fu">::</span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">idx</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  lag <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  idx <span class="op">=</span> <span class="va">idx</span>,</span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">18</span>, <span class="fl">27</span>, <span class="fl">48</span>, <span class="fl">31</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code>at</code> can also be specified as interval of the output
defined by time interval which results in obtaining results on following
indices
<code>seq(min(idx), max(idx), by = "&lt;time interval&gt;")</code>.
Interval can be set in the same way as in <code>seq.POSIXt</code>
function. It’s worth noting that <code>at</code> interval shouldn’t be
more frequent than interval of <code>idx</code> - for <code>Date</code>
the most frequent interval is a <code>"day"</code>, for
<code>POSIXt</code> it’s a <code>"sec"</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idx_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fl">365</span>, by <span class="op">=</span> <span class="st">"1 month"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># change interval to 4-months</span></span>
<span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">12</span>,</span>
<span>  idx <span class="op">=</span> <span class="va">idx_date</span>,</span>
<span>  at <span class="op">=</span> <span class="st">"4 months"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate correlation at every 6-months</span></span>
<span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">13</span>,</span>
<span>    b <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">13</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">13</span>, sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>    <span class="va">idx_date</span></span>
<span>  <span class="op">)</span>,</span>
<span>  idx <span class="op">=</span> <span class="st">"idx_date"</span>,</span>
<span>  at <span class="op">=</span> <span class="st">"6 months"</span>,</span>
<span>  f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">a</span>, <span class="va">x</span><span class="op">$</span><span class="va">b</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="move-and-stretch-window-in-time">Move and stretch window in time<a class="anchor" aria-label="anchor" href="#move-and-stretch-window-in-time"></a>
</h3>
<p>One can stretch window length by <code>k</code> and shift in time (or
index) using <code>lag</code>. Both arguments can be
<code>integer</code> and also time interval like for example
<code>2 months</code>. If <code>k</code> or <code>lag</code> are a
single value then window size/lag are constant for all elements of x.
User can also specify <code>k/lag</code> as vector, then size and lag
will vary for each window. Both <code>k</code> and <code>lag</code> can
be of <code>length(.) == 1</code>, <code>length(.) == length(x)</code>
or <code>length(.) == length(at)</code> (if <code>at</code> is
specified). <code>lag</code> can be negative and positive while
<code>k</code> only non-negative.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># summarizing - concatenating</span></span>
<span><span class="fu">runner</span><span class="fu">::</span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>  lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">5</span>, <span class="op">-</span><span class="fl">5</span>, <span class="op">-</span><span class="fl">2</span>, <span class="op">-</span><span class="fl">3</span><span class="op">)</span>,</span>
<span>  k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>  f <span class="op">=</span> <span class="va">paste</span>,</span>
<span>  collapse <span class="op">=</span> <span class="st">","</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># full window</span></span>
<span><span class="fu">runner</span><span class="fu">::</span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>  lag <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># on dates</span></span>
<span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">13</span>, <span class="fl">17</span>, <span class="fl">18</span>, <span class="fl">18</span>, <span class="fl">21</span>, <span class="fl">27</span>, <span class="fl">31</span>, <span class="fl">37</span>, <span class="fl">42</span>, <span class="fl">44</span>, <span class="fl">47</span>, <span class="fl">48</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">runner</span><span class="fu">::</span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span>,</span>
<span>  lag <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"-2 days"</span>, <span class="st">"-1 days"</span>, <span class="st">"1 days"</span>, <span class="st">"2 days"</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">15</span>,</span>
<span>    replace <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"5 days"</span>, <span class="st">"10 days"</span>, <span class="st">"15 days"</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">15</span>,</span>
<span>    replace <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="va">idx</span>,</span>
<span>  f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="na-padding">
<code>NA</code> padding<a class="anchor" aria-label="anchor" href="#na-padding"></a>
</h3>
<p>Using <code>runner</code> one can also specify
<code>na_pad = TRUE</code> which would return <code>NA</code> for any
window which is partially out of range - meaning that there is no
sufficient number of observations to fill the window. By default
<code>na_pad = FALSE</code>, which means that incomplete windows are
calculated anyway. <code>na_pad</code> is applied on normal cumulative
windows and on windows depending on date. In example below two windows
exceed range given by <code>idx</code> so for these windows are empty
for <code>na_pad = TRUE</code>. If used sets <code>na_pad = FALSE</code>
first window will be empty (no single element within
<code>[-2, 3]</code>) and last window will return elements within
matching <code>idx</code>.</p>
<p><img src="images/runner_at_date_na_pad.png"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">13</span>, <span class="fl">17</span>, <span class="fl">18</span>, <span class="fl">18</span>, <span class="fl">21</span>, <span class="fl">27</span>, <span class="fl">31</span>, <span class="fl">37</span>, <span class="fl">42</span>, <span class="fl">44</span>, <span class="fl">47</span>, <span class="fl">48</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">runner</span><span class="fu">::</span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">15</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  lag <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  idx <span class="op">=</span> <span class="va">idx</span>,</span>
<span>  at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">18</span>, <span class="fl">48</span>, <span class="fl">51</span><span class="op">)</span>,</span>
<span>  na_pad <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-runner-with-data-frame">Using runner with <code>data.frame</code><a class="anchor" aria-label="anchor" href="#using-runner-with-data-frame"></a>
</h3>
<p>User can also put <code>data.frame</code> into <code>x</code>
argument and apply functions which involve multiple columns. In example
below we calculate beta parameter of <code>lm</code> model on 1, 2, …, n
observations respectively. On the plot one can observe how
<code>lm</code> parameter adapt with increasing number of
observation.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">3</span> <span class="op">*</span> <span class="va">x</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">40</span><span class="op">)</span></span>
<span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">40</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="co"># unequaly spaced time series</span></span>
<span><span class="va">group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, <span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">group</span>, <span class="va">y</span>, <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slope</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  <span class="va">df</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coefficients</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">slope</span><span class="op">)</span></span></code></pre></div>
<p>One can also use <code>runner</code> with <code>dplyr</code> also
with problematic <code>group_by</code> operations, without need to apply
<a href="https://dplyr.tidyverse.org/reference/group_map.html" class="external-link">group_modify</a>.
Below we apply grouped 20-days beta, by specifying window length
<code>k = "10 days"</code> and providing column name where indices
(dates) are kept.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">summ</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    cumulative_mse <span class="op">=</span> <span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">.</span>,</span>
<span>      k <span class="op">=</span> <span class="st">"20 days"</span>,</span>
<span>      idx <span class="op">=</span> <span class="st">"date"</span>, <span class="co"># specify column name instead df$date</span></span>
<span>      f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coefficients</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">summ</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">cumulative_mse</span>, group <span class="op">=</span> <span class="va">group</span>, color <span class="op">=</span> <span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>When user executes multiple <code>runner</code> calls in
<code>dplyr</code> mutate, one can also use <code>run_by</code> function
to prespecify arguments in <code>tidyverse</code> pipeline. In the
example below <code>runner</code> functions are applied on
<code>k = "20 days"</code> calculated on <code>"date"</code> column.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">group</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="../reference/run_by.html">run_by</a></span><span class="op">(</span>idx <span class="op">=</span> <span class="st">"date"</span>, k <span class="op">=</span> <span class="st">"20 days"</span>, na_pad <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    cumulative_mse <span class="op">=</span> <span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">.</span>,</span>
<span>      f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">residuals</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span>,</span>
<span>    intercept <span class="op">=</span> <span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">.</span>,</span>
<span>      f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coefficients</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span>,</span>
<span>    slope <span class="op">=</span> <span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">.</span>,</span>
<span>      f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coefficients</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parallel-mode">Parallel mode<a class="anchor" aria-label="anchor" href="#parallel-mode"></a>
</h3>
<p>The <code>runner</code> function can also compute windows in parallel
mode. The function doesn’t initialize the parallel cluster automatically
but one have to do this outside and pass it to the <code>runner</code>
through <code>cl</code> argument.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span></span>
<span><span class="va">numCores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeForkCluster</a></span><span class="op">(</span><span class="va">numCores</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/runner.html">runner</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">df</span>,</span>
<span>  k <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  idx <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>  f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>,</span>
<span>  cl <span class="op">=</span> <span class="va">cl</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p><em>Executing <code>runner</code> in parallel mode isn’t always
faster than a single thread.</em> <em>Multiple-thread computation
generates some overhead due to managing the nodes.</em> <em>In general,
complex functions which bases on processor (e.g. loops) used to be</em>
<em>quicker in parallel mode but one should assess itself which option
has the</em> <em>edge in specific situation. </em></p>
</div>
<div class="section level3">
<h3 id="build-in-functions">Build-in functions<a class="anchor" aria-label="anchor" href="#build-in-functions"></a>
</h3>
<p>With <code>runner</code> one can use any R functions, but some of
them are optimized for speed reasons. These functions are:<br>
- aggregating functions - <code>length_run</code>, <code>min_run</code>,
<code>max_run</code>, <code>minmax_run</code>, <code>sum_run</code>,
<code>mean_run</code>, <code>streak_run</code><br>
- utility functions - <code>fill_run</code>, <code>lag_run</code>,
<code>which_run</code></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Dawid Kałędkowski.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
